angular.module("biigle.label-trees",["biigle.api","biigle.ui"]),angular.module("biigle.label-trees").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),angular.module("biigle.label-trees").controller("AuthorizedProjectsController",["$scope","LABEL_TREE","AUTH_PROJECTS","AUTH_OWN_PROJECTS","Project","LabelTreeAuthorizedProject",function(e,n,t,r,i,o){"use strict";var l=!1,a=!1,c=null,u=null,s=function(e){for(var n=t.length-1;n>=0;n--)if(t[n].id===e.id)return!1;return!0},d=function(e){u=e.filter(s)},f=function(e){msg.responseError(e),a=!1},b=function(e){t.push(e),r.push(e.id),d(c),a=!1},g=function(e){var n;for(n=t.length-1;n>=0;n--)if(t[n].id===e.id){t.splice(n,1);break}n=r.indexOf(e.id),n!==-1&&r.splice(n,1),d(c),a=!1};e.hasProjects=function(){return t.length>0},e.getProjects=function(){return t},e.isOwnProject=function(e){return r.indexOf(e.id)!==-1},e.isEditing=function(){return l},e.getVisibilityId=function(){return n.visibility_id},e.toggleEditing=function(){c||(c=i.query(d)),l=!l},e.isLoading=function(){return a},e.getProjectsForAuthorization=function(){return u},e.addAuthorizedProject=function(e){a=!0,o.addAuthorized({id:n.id},{id:e.id},function(){b(e)},f)},e.removeAuthorizedProject=function(e){a=!0,o.removeAuthorized({id:n.id},{id:e.id},function(){g(e)},f)}}]),angular.module("biigle.label-trees").controller("LabelTreeController",["$scope","LABEL_TREE","LabelTree","msg","$timeout","LabelTreeUser","USER_ID","REDIRECT_URL",function(e,n,t,r,i,o,l,a){"use strict";var c=!1,u=!1;e.labelTreeInfo={name:n.name,description:n.description,visibility_id:n.visibility_id.toString()};var s=function(e){r.responseError(e),u=!1},d=function(e){n.name=e.name,n.description=e.description,n.visibility_id=parseInt(e.visibility_id),c=!1,u=!1},f=function(){r.success("The label tree was deleted. Redirecting..."),i(function(){window.location.href=a},2e3)},b=function(e){e?(r.success("You left the label tree. Redirecting..."),i(function(){window.location.href=a},2e3)):(r.success("You left the label tree. Reloading..."),i(function(){window.location.reload()},2e3))};e.isEditing=function(){return c},e.toggleEditing=function(){c=!c},e.isSaving=function(){return u},e.getVisibilityId=function(){return n.visibility_id},e.getName=function(){return n.name},e.getDescription=function(){return n.description},e.saveChanges=function(){u=!0,t.update({id:n.id,name:e.labelTreeInfo.name,description:e.labelTreeInfo.description,visibility_id:parseInt(e.labelTreeInfo.visibility_id)},d,s)},e.discardChanges=function(){e.labelTreeInfo.name=n.name,e.labelTreeInfo.description=n.description,e.labelTreeInfo.visibility_id=n.visibility_id.toString(),c=!1},e.deleteTree=function(){confirm("Do you really want to delete the label tree "+n.name+"?")&&t["delete"]({id:n.id},f,r.responseError)},e.leaveTree=function(e){confirm("Do you really want to leave the label tree "+n.name+"?")&&o.detach({label_tree_id:n.id},{id:l},function(){b(e)},r.responseError)}}]),angular.module("biigle.label-trees").controller("LabelsController",["$scope","LABELS","LABEL_TREE","Label","msg","$q",function(e,n,t,r,i,o){"use strict";var l=!1,a=!1,c=null;e.tree={},e.openHierarchy=[];var u=function(e){i.responseError(e),a=!1},s=function(){e.tree={},n.forEach(function(n){var t=n.parent_id;e.tree[t]?e.tree[t].push(n):e.tree[t]=[n]})},d=function(t){Array.prototype.push.apply(n,t),s(),e.$broadcast("labels.refresh"),a=!1},f=function(t){for(var r=n.length-1;r>=0;r--)if(n[r].id===t.id){n.splice(r,1);break}s(),e.$broadcast("labels.refresh"),c&&c.id===t.id&&(c=b(t.parent_id)),e.selectLabel(c),a=!1},b=function(e){for(var t=n.length-1;t>=0;t--)if(n[t].id===e)return n[t];return null},g=function(n){var t=n;if(e.openHierarchy.length=0,t)for(;null!==t.parent_id;)e.openHierarchy.unshift(t.parent_id),t=b(t.parent_id)};e.selectLabel=function(n){c=n,g(n),e.$broadcast("labels.selected",n)},e.isSelectedLabel=function(e){return c&&c.id===e.id},e.hasLabels=function(){return n.length>0},e.isEditing=function(){return l},e.toggleEditing=function(){l=!l},e.getLabels=function(){return n},e.createLabel=function(e){if(a){var n=o.defer();return n.resolve([]),n.promise}return a=!0,e.label_tree_id=t.id,r.create(e,d,u).$promise},e.removeLabel=function(e,n){a=!0,n.stopPropagation(),r["delete"]({id:e.id},function(){f(e)},u)},e.isLoading=function(){return a},e.startLoading=function(){a=!0},e.stopLoading=function(){a=!1},s()}]),angular.module("biigle.label-trees").controller("ManualLabelsController",["$scope","randomColor",function(e,n){"use strict";var t={LABEL:null,NAME:""};e.selected={label:t.LABEL,color:n.get(),name:t.NAME};var r=function(){e.resetName(),e.selected.label&&"#"+e.selected.label.color===e.selected.color||e.refreshColor()};e.resetParent=function(){e.selectLabel(t.LABEL)},e.refreshColor=function(){e.selected.color=n.get()},e.resetName=function(){e.selected.name=t.NAME},e.isNameDirty=function(){return e.selected.name!==t.NAME},e.isParentDirty=function(){return e.selected.label!==t.LABEL},e.addLabel=function(){var n={name:e.selected.name,color:e.selected.color};e.selected.label&&(n.parent_id=e.selected.label.id),e.createLabel(n).then(r)},e.$on("labels.selected",function(n,t){e.selected.label=t,t&&(e.selected.color="#"+t.color)})}]),angular.module("biigle.label-trees").controller("MembersController",["$scope","LABEL_TREE","MEMBERS","ROLES","DEFAULT_ROLE_ID","USER_ID","LabelTreeUser","msg","User",function(e,n,t,r,i,o,l,a,c){"use strict";var u=!1,s=!1;e.newMember={user:null,role_id:i.toString()};var d=function(e){a.responseError(e),s=!1},f=function(e){e.role_id=parseInt(e.tmp_role_id),s=!1},b=function(e,n){e.tmp_role_id=e.role_id.toString(),d(n)},g=function(e){for(var n=t.length-1;n>=0;n--)if(t[n].id===e.id){t.splice(n,1);break}s=!1},m=function(e){for(var n=t.length-1;n>=0;n--)if(t[n].id===e.id)return!1;return!0},p=function(e){return e.filter(m)},h=function(n){n.tmp_role_id=n.role_id.toString(),t.push(n),e.newMember.user=null,s=!1};e.isEditing=function(){return u},e.toggleEditing=function(){u=!u},e.isLoading=function(){return s},e.getMembers=function(){return t},e.hasMembers=function(){return t.length>0},e.getRoles=function(){return r},e.getRole=function(e){return r[e]},e.isOwnUser=function(e){return o===e.id},e.updateRole=function(e){s=!0,l.update({label_tree_id:n.id},{id:e.id,role_id:parseInt(e.tmp_role_id)},function(){f(e)},function(n){b(e,n)})},e.detachMember=function(e){s=!0,l.detach({label_tree_id:n.id},{id:e.id},function(){g(e)},d)},e.username=function(e){return e&&e.firstname&&e.lastname?e.firstname+" "+e.lastname:""},e.findUser=function(e){return c.find({query:encodeURIComponent(e)}).$promise.then(p)},e.newMemberValid=function(){return e.newMember.user&&void 0!==e.newMember.user.id&&m(e.newMember.user)&&null!==e.newMember.role_id},e.attachMember=function(){if(e.newMemberValid()){s=!0;var t=e.newMember.user;t.role_id=parseInt(e.newMember.role_id),l.attach({label_tree_id:n.id},{id:t.id,role_id:t.role_id},function(){h(t)},d)}};for(var _=t.length-1;_>=0;_--)t[_].tmp_role_id=t[_].role_id.toString()}]),angular.module("biigle.label-trees").controller("WormsLabelsController",["$scope","LabelSource","LABEL_SOURCES","msg","randomColor",function(e,n,t,r,i){"use strict";var o=function(){for(var e=t.length-1;e>=0;e--)if("worms"===t[e].name)return t[e]}(),l={LABEL:null,NAME:""},a=[],c=!1,u=!1,s=[],d=function(n){c=!1,e.stopLoading(),r.responseError(n)},f=function(){c=!1,e.stopLoading()},b=function(n){for(var t=n.length-1;t>=0;t--)s.push(parseInt(n[t].source_id));e.selected.label&&"#"+e.selected.label.color===e.selected.color||e.refreshColor()};e.selected={label:l.LABEL,color:i.get(),name:l.NAME},e.getFindResults=function(){return a},e.isFinding=function(){return c},e.hasFindResults=function(){return a.length>0},e.find=function(){c=!0,e.startLoading(),a=n.query({id:o.id,query:e.selected.name},f,d)},e.getClassification=function(e){return e.parents.join(" > ")},e.resetParent=function(){e.selectLabel(l.LABEL)},e.refreshColor=function(){e.selected.color=i.get()},e.isNameDirty=function(){return e.selected.name!==l.NAME},e.isParentDirty=function(){return e.selected.label!==l.LABEL},e.toggleRecursive=function(){u=!u},e.isRecursive=function(){return u},e.addLabel=function(n){var t={name:n.name,color:e.selected.color,source_id:n.aphia_id,label_source_id:o.id};u?t.recursive="true":e.selected.label&&(t.parent_id=e.selected.label.id),e.createLabel(t).then(b)},e.getAddButtonTitle=function(n){return e.isRecursive()?"Add "+n.name+" and all WoRMS parents as new labels":e.isParentDirty()?"Add "+n.name+" as a child of "+e.selected.label.name:"Add "+n.name+" as a root label"},e.hasBeenImported=function(e){return s.indexOf(e.aphia_id)!==-1},e.$on("labels.selected",function(n,t){e.selected.label=t,t&&(e.selected.color="#"+t.color)})}]),angular.module("biigle.label-trees").directive("labelTreeItem",["$compile","$timeout","$templateCache",function(e,n,t){"use strict";return{restrict:"C",templateUrl:"label-item.html",scope:!0,link:function(r,i,o){var l=angular.element(t.get("label-subtree.html"));n(function(){i.append(e(l)(r))})},controller:["$scope",function(e){var n=!1,t=!1,r=!1,i=function(){e.openHierarchy.indexOf(e.item.id)!==-1?(n=!0,r=!1):e.isSelectedLabel(e.item)?(n=!0,r=!0):(n=!1,r=!1)},o=function(){t=e.tree&&e.tree.hasOwnProperty(e.item.id)};e.getSubtree=function(){return n?e.tree[e.item.id]:[]},e.getClass=function(){return{open:n,expandable:t,selected:r}},e.$on("labels.selected",i),e.$on("labels.refresh",o),i(),o()}]}}]),angular.module("biigle.label-trees").service("randomColor",function(){"use strict";var e=[0,.5,.9],n=[360,1,1],t=[0,2,2],r=function(e){var n,t=e[0]/60,r=Math.floor(t),i=t-r,o=[e[2]*(1-e[1]),e[2]*(1-e[1]*i),e[2]*(1-e[1]*(1-i))];switch(r){case 1:n=[o[1],e[2],o[0]];break;case 2:n=[o[0],e[2],o[2]];break;case 3:n=[o[0],o[1],e[2]];break;case 4:n=[o[2],o[0],e[2]];break;case 5:n=[e[2],o[0],o[1]];break;default:n=[e[2],o[2],o[0]]}return n.map(function(e){return Math.round(255*e)})},i=function(e){return e.map(function(e){return e=e.toString(16),1===e.length?"0"+e:e})};this.get=function(){for(var o,l=[0,0,0],a=l.length-1;a>=0;a--)o=10*t[a],l[a]=(n[a]-e[a])*Math.random()+e[a],0!==o?l[a]=Math.round(l[a]*o)/o:l[a]=Math.round(l[a]);return"#"+i(r(l)).join("")}});