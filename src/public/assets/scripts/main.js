angular.module("biigle.label-trees",["biigle.api","biigle.ui"]),angular.module("biigle.label-trees").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),biigle.$viewModel("label-trees-labels",function(e){var t=biigle.$require("api.labels"),i=biigle.$require("messages.store"),l=biigle.$require("labelTrees.randomColor"),n=biigle.$require("labelTrees.labelTree");new Vue({el:e,data:{editing:!1,loading:!1,labels:biigle.$require("labelTrees.labels"),selectedColor:l(),selectedLabel:null,selectedName:""},components:{typeahead:VueStrap.typeahead,tabs:VueStrap.tabs,tab:VueStrap.tab,labelTree:biigle.$require("labelTrees.components.labelTree"),manualLabelForm:biigle.$require("labelTrees.components.manualLabelForm"),wormsLabelForm:biigle.$require("labelTrees.components.wormsLabelForm")},computed:{classObject:function(){return{"panel-warning":this.editing}}},methods:{toggleEditing:function(){this.editing=!this.editing},startLoading:function(){this.loading=!0},finishLoading:function(){this.loading=!1},deleteLabel:function(e){var l=this;this.startLoading(),t.delete({id:e.id}).then(function(){l.labelDeleted(e)},i.handleErrorResponse).finally(this.finishLoading)},labelDeleted:function(e){this.selectedLabel&&this.selectedLabel.id===e.id&&this.deselectLabel(e);for(var t=this.labels.length-1;t>=0;t--)if(this.labels[t].id===e.id){this.labels.splice(t,1);break}},selectLabel:function(e){this.selectedLabel=e,e?(this.selectedColor="#"+e.color,this.$emit("select",e)):this.$emit("clear")},deselectLabel:function(e){this.selectedLabel=null,this.$emit("deselect",e)},selectColor:function(e){this.selectedColor=e},selectName:function(e){this.selectedName=e},insertLabel:function(e){Vue.set(e,"open",!1),Vue.set(e,"selected",!1);for(var t=e.name.toLowerCase(),i=0,l=this.labels.length;i<l;i++)if(this.labels[i].name.toLowerCase()>=t)return void this.labels.splice(i,0,e);this.labels.push(e)},createLabel:function(e){this.loading||(this.startLoading(),t.save({label_tree_id:n.id},e).then(this.labelCreated,i.handleErrorResponse).finally(this.finishLoading))},labelCreated:function(e){e.data.forEach(this.insertLabel),this.selectedColor=l(),this.selectedName=""}}})}),biigle.$viewModel("label-trees-title",function(e){var t=biigle.$require("messages.store"),i=biigle.$require("labelTrees.labelTree"),l=biigle.$require("labelTrees.privateVisibilityId"),n=biigle.$require("api.labelTreeUser"),a=biigle.$require("api.labelTree");new Vue({el:e,mixins:[biigle.$require("labelTrees.mixins.loader")],data:{editing:!1,name:i.name,description:i.description,visibility_id:i.visibility_id},components:{},computed:{isPrivate:function(){return parseInt(this.visibility_id)===l},hasDescription:function(){return!!this.description.length},isChanged:function(){return this.name!==i.name||this.description!==i.description||parseInt(this.visibility_id)!==i.visibility_id}},methods:{startEditing:function(){this.editing=!0},discardChanges:function(){this.editing=!1,this.name=i.name,this.description=i.description,this.visibility_id=i.visibility_id},leaveTree:function(){var e=confirm("Do you really want to leave the label tree "+i.name+"?");e&&(this.startLoading(),n.delete({label_tree_id:i.id,id:biigle.$require("labelTrees.userId")}).then(this.treeLeft,t.handleErrorResponse).finally(this.finishLoading))},treeLeft:function(){this.isPrivate?(t.success("You left the label tree. Redirecting..."),setTimeout(function(){location.href=biigle.$require("labelTrees.redirectUrl")},2e3)):location.reload()},deleteTree:function(){var e=confirm("Do you really want to delete the label tree "+i.name+"?");e&&(this.startLoading(),a.delete({id:i.id}).then(this.treeDeleted,t.handleErrorResponse).finally(this.finishLoading))},treeDeleted:function(){t.success("The label tree was deleted. Redirecting..."),setTimeout(function(){location.href=biigle.$require("labelTrees.redirectUrl")},2e3)},saveChanges:function(){this.startLoading(),a.update({id:i.id},{name:this.name,description:this.description,visibility_id:this.visibility_id}).then(this.changesSaved,t.handleErrorResponse).finally(this.finishLoading)},changesSaved:function(){i.name=this.name,i.description=this.description,i.visibility_id=parseInt(this.visibility_id),this.editing=!1}}})}),biigle.$declare("labelTrees.randomColor",function(){var e=[0,.5,.9],t=[360,1,1],i=[0,2,2],l=function(e){var t,i=e[0]/60,l=Math.floor(i),n=i-l,a=[e[2]*(1-e[1]),e[2]*(1-e[1]*n),e[2]*(1-e[1]*(1-n))];switch(l){case 1:t=[a[1],e[2],a[0]];break;case 2:t=[a[0],e[2],a[2]];break;case 3:t=[a[0],a[1],e[2]];break;case 4:t=[a[2],a[0],e[2]];break;case 5:t=[e[2],a[0],a[1]];break;default:t=[e[2],a[2],a[0]]}return t.map(function(e){return Math.round(255*e)})},n=function(e){return e.map(function(e){return e=e.toString(16),1===e.length?"0"+e:e})};return function(){for(var a,s=[0,0,0],r=s.length-1;r>=0;r--)a=10*i[r],s[r]=(t[r]-e[r])*Math.random()+e[r],0!==a?s[r]=Math.round(s[r]*a)/a:s[r]=Math.round(s[r]);return"#"+n(l(s)).join("")}}),angular.module("biigle.label-trees").controller("AuthorizedProjectsController",["$scope","LABEL_TREE","AUTH_PROJECTS","AUTH_OWN_PROJECTS","Project","LabelTreeAuthorizedProject",function(e,t,i,l,n,a){"use strict";var s=!1,r=!1,o=null,c=null,d=function(e){for(var t=i.length-1;t>=0;t--)if(i[t].id===e.id)return!1;return!0},u=function(e){c=e.filter(d)},b=function(e){msg.responseError(e),r=!1},h=function(e){i.push(e),l.push(e.id),u(o),r=!1},p=function(e){var t;for(t=i.length-1;t>=0;t--)if(i[t].id===e.id){i.splice(t,1);break}t=l.indexOf(e.id),t!==-1&&l.splice(t,1),u(o),r=!1};e.hasProjects=function(){return i.length>0},e.getProjects=function(){return i},e.isOwnProject=function(e){return l.indexOf(e.id)!==-1},e.isEditing=function(){return s},e.getVisibilityId=function(){return t.visibility_id},e.toggleEditing=function(){o||(o=n.query(u)),s=!s},e.isLoading=function(){return r},e.getProjectsForAuthorization=function(){return c},e.addAuthorizedProject=function(e){r=!0,a.addAuthorized({id:t.id},{id:e.id},function(){h(e)},b)},e.removeAuthorizedProject=function(e){r=!0,a.removeAuthorized({id:t.id},{id:e.id},function(){p(e)},b)}}]),angular.module("biigle.label-trees").controller("MembersController",["$scope","LABEL_TREE","MEMBERS","ROLES","DEFAULT_ROLE_ID","USER_ID","LabelTreeUser","msg","User",function(e,t,i,l,n,a,s,r,o){"use strict";var c=!1,d=!1;e.newMember={user:null,role_id:n.toString()};var u=function(e){r.responseError(e),d=!1},b=function(e){e.role_id=parseInt(e.tmp_role_id),d=!1},h=function(e,t){e.tmp_role_id=e.role_id.toString(),u(t)},p=function(e){for(var t=i.length-1;t>=0;t--)if(i[t].id===e.id){i.splice(t,1);break}d=!1},m=function(e){for(var t=i.length-1;t>=0;t--)if(i[t].id===e.id)return!1;return!0},f=function(e){return e.filter(m)},g=function(t){t.tmp_role_id=t.role_id.toString(),i.push(t),e.newMember.user=null,d=!1};e.isEditing=function(){return c},e.toggleEditing=function(){c=!c},e.isLoading=function(){return d},e.getMembers=function(){return i},e.hasMembers=function(){return i.length>0},e.getRoles=function(){return l},e.getRole=function(e){return l[e]},e.isOwnUser=function(e){return a===e.id},e.updateRole=function(e){d=!0,s.update({label_tree_id:t.id},{id:e.id,role_id:parseInt(e.tmp_role_id)},function(){b(e)},function(t){h(e,t)})},e.detachMember=function(e){d=!0,s.detach({label_tree_id:t.id},{id:e.id},function(){p(e)},u)},e.username=function(e){return e&&e.firstname&&e.lastname?e.firstname+" "+e.lastname:""},e.findUser=function(e){return o.find({query:encodeURIComponent(e)}).$promise.then(f)},e.newMemberValid=function(){return e.newMember.user&&void 0!==e.newMember.user.id&&m(e.newMember.user)&&null!==e.newMember.role_id},e.attachMember=function(){if(e.newMemberValid()){d=!0;var i=e.newMember.user;i.role_id=parseInt(e.newMember.role_id),s.attach({label_tree_id:t.id},{id:i.id,role_id:i.role_id},function(){g(i)},u)}};for(var v=i.length-1;v>=0;v--)i[v].tmp_role_id=i[v].role_id.toString()}]),biigle.$declare("api.labelSource",Vue.resource("/api/v1/label-sources{/id}/find")),biigle.$declare("api.labelTree",Vue.resource("/api/v1/label-trees{/id}")),biigle.$declare("api.labelTreeUser",Vue.resource("/api/v1/label-trees{/label_tree_id}/users{/id}")),biigle.$declare("api.labels",Vue.resource("/api/v1/labels{/id}",{},{save:{method:"POST",url:"/api/v1/label-trees{/label_tree_id}/labels"}})),biigle.$component("labelTrees.components.labelTree",{template:'<div class="label-tree"><h4 class="label-tree__title" v-if="showTitle"><button v-if="collapsible" @click.stop="collapse" class="btn btn-default btn-xs pull-right" :title="collapseTitle"><span v-if="collapsed" class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span><span v-else class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>{{name}}</h4><ul v-if="!collapsed" class="label-tree__list"><label-tree-label :label="label" :deletable="deletable" v-for="label in rootLabels" @select="emitSelect" @deselect="emitDeselect" @delete="emitDelete"></label-tree-label></ul></div>',data:function(){return{collapsed:!1}},components:{labelTreeLabel:biigle.$require("labelTrees.components.labelTreeLabel")},props:{name:{type:String,required:!0},labels:{type:Array,required:!0},showTitle:{type:Boolean,default:!0},standalone:{type:Boolean,default:!1},collapsible:{type:Boolean,default:!0},multiselect:{type:Boolean,default:!1},deletable:{type:Boolean,default:!1}},computed:{labelMap:function(){for(var e={},t=this.labels.length-1;t>=0;t--)e[this.labels[t].id]=this.labels[t];return e},compiledLabels:function(){for(var e,t={},i=0,l=this.labels.length;i<l;i++)e=this.labels[i].parent_id,t.hasOwnProperty(e)?t[e].push(this.labels[i]):t[e]=[this.labels[i]];for(i=this.labels.length-1;i>=0;i--)t.hasOwnProperty(this.labels[i].id)?Vue.set(this.labels[i],"children",t[this.labels[i].id]):(Vue.set(this.labels[i],"children",void 0),this.labels[i].open=!1);return t},rootLabels:function(){return this.compiledLabels[null]},collapseTitle:function(){return this.collapsed?"Expand":"Collapse"}},methods:{hasLabel:function(e){return this.labelMap.hasOwnProperty(e)},getLabel:function(e){return this.labelMap[e]},getParents:function(e){for(var t=[];null!==e.parent_id;)e=this.getLabel(e.parent_id),t.unshift(e.id);return t},emitSelect:function(e){this.$emit("select",e)},emitDeselect:function(e){this.$emit("deselect",e)},emitDelete:function(e){this.$emit("delete",e)},selectLabel:function(e){if(this.multiselect||this.clearSelectedLabels(),this.hasLabel(e.id)){e.selected=!0,this.collapsed=!1;for(var t=this.getParents(e),i=t.length-1;i>=0;i--)this.getLabel(t[i]).open=!0}},deselectLabel:function(e){this.hasLabel(e.id)&&(e.selected=!1)},clearSelectedLabels:function(){for(var e=this.labels.length-1;e>=0;e--)this.labels[e].selected=!1},collapse:function(){this.collapsed=!this.collapsed}},created:function(){for(i=this.labels.length-1;i>=0;i--)Vue.set(this.labels[i],"open",!1),Vue.set(this.labels[i],"selected",!1);this.standalone?(this.$on("select",this.selectLabel),this.$on("deselect",this.deselectLabel)):(this.$parent.$on("select",this.selectLabel),this.$parent.$on("deselect",this.deselectLabel),this.$parent.$on("clear",this.clearSelectedLabels))}}),biigle.$component("labelTrees.components.labelTreeLabel",{name:"label-tree-label",template:'<li class="label-tree-label cf" :class="classObject"><div class="label-tree-label__name" @click="toggleOpen"><span class="label-tree-label__color" :style="colorStyle"></span><span v-text="label.name" @click.stop="toggleSelect"></span><span v-if="showFavourite" class="label-tree-label__favourite" @click.stop="toggleFavourite"><span class="glyphicon" :class="favouriteClass" aria-hidden="true" title=""></span></span><button v-if="deletable" type="button" class="close label-tree-label__delete" :title="deleteTitle" @click.stop="deleteThis"><span aria-hidden="true">&times;</span></button></div><ul v-if="label.open" class="label-tree__list"><label-tree-label :label="child" :deletable="deletable" v-for="child in label.children" @select="emitSelect" @deselect="emitDeselect" @delete="emitDelete"></label-tree-label></ul></li>',data:function(){return{favourite:!1}},props:{label:{type:Object,required:!0},showFavourite:{type:Boolean,required:!1},deletable:{type:Boolean,default:!1}},computed:{classObject:function(){return{"label-tree-label--selected":this.label.selected,"label-tree-label--expandable":this.label.children}},colorStyle:function(){return{"background-color":"#"+this.label.color}},favouriteClass:function(){return{"glyphicon-star-empty":!this.favourite,"glyphicon-star":this.favourite}},deleteTitle:function(){return"Remove label "+this.label.name}},methods:{toggleSelect:function(){this.label.selected?this.$emit("deselect",this.label):this.$emit("select",this.label)},deleteThis:function(){this.emitDelete(this.label)},toggleOpen:function(){this.label.children?this.label.open=!this.label.open:this.toggleSelect()},toggleFavourite:function(){this.favourite=!this.favourite},emitSelect:function(e){this.$emit("select",e)},emitDeselect:function(e){this.$emit("deselect",e)},emitDelete:function(e){this.$emit("delete",e)}}}),biigle.$component("labelTrees.components.labelTrees",{template:'<div class="label-trees"><div v-if="typeahead || clearable" class="label-trees__head"><button v-if="clearable" @click="clear" class="btn btn-default" title="Clear selected labels"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button><label-typeahead v-if="typeahead" :labels="labels" @select="handleSelect"></label-typeahead></div><div class="label-trees__body"><label-tree :name="tree.name" :labels="tree.labels" :multiselect="multiselect" v-for="tree in trees" @select="handleSelect" @deselect="handleDeselect"></label-tree></div></div>',components:{labelTypeahead:biigle.$require("labelTrees.components.labelTypeahead"),labelTree:biigle.$require("labelTrees.components.labelTree")},props:{trees:{type:Array,required:!0},typeahead:{type:Boolean,default:!0},clearable:{type:Boolean,default:!0},multiselect:{type:Boolean,default:!1}},computed:{labels:function(){for(var e=[],t=this.trees.length-1;t>=0;t--)Array.prototype.push.apply(e,this.trees[t].labels);return e}},methods:{handleSelect:function(e){this.$emit("select",e)},handleDeselect:function(e){this.$emit("deselect",e)},clear:function(){this.$emit("clear")}}}),biigle.$component("labelTrees.components.labelTypeahead",{template:'<typeahead class="label-typeahead clearfix" :data="labels" :placeholder="placeholder" :on-hit="selectLabel" :template="template" :disabled="disabled" :value="value" match-property="name"></typeahead>',data:function(){return{template:"{{item.name}}"}},components:{typeahead:VueStrap.typeahead},props:{labels:{type:Array,required:!0},placeholder:{type:String,default:"Label name"},disabled:{type:Boolean,default:!1},value:{type:String,default:""}},methods:{selectLabel:function(e,t){this.$emit("select",e),t.reset()}}}),biigle.$component("labelTrees.components.manualLabelForm",{mixins:[biigle.$require("labelTrees.mixins.labelFormComponent")],methods:{submit:function(){var e={name:this.selectedName,color:this.selectedColor};this.parent&&(e.parent_id=this.parent.id),this.$emit("submit",e)}}}),biigle.$component("labelTrees.components.wormsLabelForm",{mixins:[biigle.$require("labelTrees.mixins.labelFormComponent")],components:{wormsResultItem:biigle.$require("labelTrees.components.wormsResultItem")},data:function(){return{results:[],recursive:!1,hasSearched:!1}},computed:{hasResults:function(){return this.results.length>0},recursiveButtonClass:function(){return{active:this.recursive,"btn-primary":this.recursive}}},methods:{submit:function(){},findName:function(){var e=biigle.$require("labelTrees.wormsLabelSource"),t=biigle.$require("api.labelSource"),i=biigle.$require("messages.store"),l=this;this.$emit("load-start"),t.query({id:e.id,query:this.selectedName}).then(this.updateResults,i.handleErrorResponse).finally(function(){l.hasSearched=!0,l.$emit("load-finish")})},updateResults:function(e){this.results=e.data},importItem:function(e){var t=biigle.$require("labelTrees.wormsLabelSource"),i={name:e.name,color:this.selectedColor,source_id:e.aphia_id,label_source_id:t.id};this.recursive?i.recursive="true":this.parent&&(i.parent_id=this.parent.id),this.$emit("submit",i)},toggleRecursive:function(){this.recursive=!this.recursive}}}),biigle.$component("labelTrees.components.wormsResultItem",{props:{item:{type:Object,required:!0},recursive:{type:Boolean,required:!0},labels:{type:Array,required:!0},parent:{type:Object,default:null}},computed:{classification:function(){return this.item.parents.join(" > ")},buttonTitle:function(){return this.recursive?"Add "+this.item.name+" and all WoRMS parents as new labels":this.parent?"Add "+this.item.name+" as a child of "+this.parent.name:"Add "+this.item.name+" as a root label"},classObject:function(){return{"list-group-item-success":this.selected}},selected:function(){var e=this;return!!this.labels.find(function(t){return t.source_id==e.item.aphia_id})}},methods:{select:function(){this.selected||this.$emit("select",this.item)}}}),biigle.$component("labelTrees.mixins.labelFormComponent",{props:{labels:{type:Array,required:!0},color:{type:String,default:""},parent:{type:Object,default:null},name:{type:String,default:""}},components:{labelTypeahead:biigle.$require("labelTrees.components.labelTypeahead")},computed:{selectedColor:{get:function(){return this.color},set:function(e){this.$emit("color",e)}},selectedName:{get:function(){return this.name},set:function(e){this.$emit("name",e)}},selectedParent:function(){return this.parent?this.parent.name:""},hasNoLabels:function(){return 0===this.labels.length},hasNoParent:function(){return!this.parent},hasNoName:function(){return!this.name}},methods:{refreshColor:function(){this.selectedColor=biigle.$require("labelTrees.randomColor")()},resetParent:function(){this.$emit("parent",null)},selectLabel:function(e){this.$emit("parent",e)}}}),biigle.$component("labelTrees.mixins.loader",{data:{loading:!1},methods:{startLoading:function(){this.loading=!0},finishLoading:function(){this.loading=!1}}});