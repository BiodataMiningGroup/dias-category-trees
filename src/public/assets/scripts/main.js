biigle.$viewModel("label-trees-labels",function(e){var t=biigle.$require("api.labels"),l=biigle.$require("messages.store"),i=biigle.$require("labelTrees.randomColor"),n=biigle.$require("labelTrees.labelTree");new Vue({el:e,data:{editing:!0,loading:!1,labels:biigle.$require("labelTrees.labels"),selectedColor:i(),selectedLabel:null,selectedName:""},components:{typeahead:VueStrap.typeahead,tabs:VueStrap.tabs,tab:VueStrap.tab,labelTree:biigle.$require("labelTrees.components.labelTree"),manualLabelForm:biigle.$require("labelTrees.components.manualLabelForm")},computed:{classObject:function(){return{"panel-warning":this.editing}}},methods:{toggleEditing:function(){this.editing=!this.editing},finishLoading:function(){this.loading=!1},deleteLabel:function(e){var i=this;this.loading=!0,t["delete"]({id:e.id}).then(function(){i.labelDeleted(e)},l.handleErrorResponse)["finally"](this.finishLoading)},labelDeleted:function(e){this.selectedLabel&&this.selectedLabel.id===e.id&&this.deselectLabel(e);for(var t=this.labels.length-1;t>=0;t--)if(this.labels[t].id===e.id){this.labels.splice(t,1);break}},selectLabel:function(e){this.selectedLabel=e,e?this.$emit("select",e):this.$emit("clear")},deselectLabel:function(e){this.selectedLabel=null,this.$emit("deselect",e)},selectColor:function(e){this.selectedColor=e},selectName:function(e){this.selectedName=e},insertLabel:function(e){for(var t=e.name.toLowerCase(),l=0,i=this.labels.length;i>l;l++)if(this.labels[l].name.toLowerCase()>=t)return void this.labels.splice(l,0,e);this.labels.push(e)},createLabel:function(){if(!this.loading){this.loading=!0;var e={name:this.selectedName,color:this.selectedColor};this.selectedLabel&&(e.parent_id=this.selectedLabel.id),t.save({label_tree_id:n.id},e).then(this.labelCreated,l.handleErrorResponse)["finally"](this.finishLoading)}},labelCreated:function(e){this.insertLabel(e.data[0]),this.selectedColor=i()}}})}),biigle.$declare("labelTrees.randomColor",function(){var e=[0,.5,.9],t=[360,1,1],l=[0,2,2],i=function(e){var t,l=e[0]/60,i=Math.floor(l),n=l-i,r=[e[2]*(1-e[1]),e[2]*(1-e[1]*n),e[2]*(1-e[1]*(1-n))];switch(i){case 1:t=[r[1],e[2],r[0]];break;case 2:t=[r[0],e[2],r[2]];break;case 3:t=[r[0],r[1],e[2]];break;case 4:t=[r[2],r[0],e[2]];break;case 5:t=[e[2],r[0],r[1]];break;default:t=[e[2],r[2],r[0]]}return t.map(function(e){return Math.round(255*e)})},n=function(e){return e.map(function(e){return e=e.toString(16),1===e.length?"0"+e:e})};return function(){for(var r,a=[0,0,0],o=a.length-1;o>=0;o--)r=10*l[o],a[o]=(t[o]-e[o])*Math.random()+e[o],0!==r?a[o]=Math.round(a[o]*r)/r:a[o]=Math.round(a[o]);return"#"+n(i(a)).join("")}}),angular.module("biigle.label-trees",["biigle.api","biigle.ui"]),angular.module("biigle.label-trees").config(["$compileProvider",function(e){"use strict";e.debugInfoEnabled(!1)}]),biigle.$declare("api.labels",Vue.resource("/api/v1/labels{/id}",{},{save:{method:"POST",url:"/api/v1/label-trees{/label_tree_id}/labels"}})),biigle.$component("labelTrees.components.labelTree",{template:'<div class="label-tree"><h4 class="label-tree__title" v-if="showTitle"><button v-if="collapsible" @click.stop="collapse" class="btn btn-default btn-xs pull-right" :title="collapseTitle"><span v-if="collapsed" class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span><span v-else class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>{{name}}</h4><ul v-if="!collapsed" class="label-tree__list"><label-tree-label :label="label" :deletable="deletable" v-for="label in rootLabels" @select="emitSelect" @deselect="emitDeselect" @delete="emitDelete"></label-tree-label></ul></div>',data:function(){return{collapsed:!1}},components:{labelTreeLabel:biigle.$require("labelTrees.components.labelTreeLabel")},props:{name:{type:String,required:!0},labels:{type:Array,required:!0},showTitle:{type:Boolean,"default":!0},standalone:{type:Boolean,"default":!1},collapsible:{type:Boolean,"default":!0},multiselect:{type:Boolean,"default":!1},deletable:{type:Boolean,"default":!1}},computed:{labelMap:function(){for(var e={},t=this.labels.length-1;t>=0;t--)e[this.labels[t].id]=this.labels[t];return e},compiledLabels:function(){for(var e,t={},l=0,i=this.labels.length;i>l;l++)e=this.labels[l].parent_id,t.hasOwnProperty(e)?t[e].push(this.labels[l]):t[e]=[this.labels[l]];for(l=this.labels.length-1;l>=0;l--)t.hasOwnProperty(this.labels[l].id)?Vue.set(this.labels[l],"children",t[this.labels[l].id]):Vue.set(this.labels[l],"children",void 0);return t},rootLabels:function(){return this.compiledLabels[null]},collapseTitle:function(){return this.collapsed?"Expand":"Collapse"}},methods:{hasLabel:function(e){return this.labelMap.hasOwnProperty(e)},getLabel:function(e){return this.labelMap[e]},getParents:function(e){for(var t=[];null!==e.parent_id;)e=this.getLabel(e.parent_id),t.unshift(e.id);return t},emitSelect:function(e){this.$emit("select",e)},emitDeselect:function(e){this.$emit("deselect",e)},emitDelete:function(e){this.$emit("delete",e)},selectLabel:function(e){if(this.multiselect||this.clearSelectedLabels(),this.hasLabel(e.id)){e.selected=!0,this.collapsed=!1;for(var t=this.getParents(e),l=t.length-1;l>=0;l--)this.getLabel(t[l]).open=!0}},deselectLabel:function(e){this.hasLabel(e.id)&&(e.selected=!1)},clearSelectedLabels:function(){for(var e=this.labels.length-1;e>=0;e--)this.labels[e].selected=!1},collapse:function(){this.collapsed=!this.collapsed}},created:function(){for(i=this.labels.length-1;i>=0;i--)Vue.set(this.labels[i],"open",!1),Vue.set(this.labels[i],"selected",!1);this.standalone?(this.$on("select",this.selectLabel),this.$on("deselect",this.deselectLabel)):(this.$parent.$on("select",this.selectLabel),this.$parent.$on("deselect",this.deselectLabel),this.$parent.$on("clear",this.clearSelectedLabels))}}),biigle.$component("labelTrees.components.labelTreeLabel",{name:"label-tree-label",template:'<li class="label-tree-label cf" :class="classObject"><div class="label-tree-label__name" @click="toggleOpen"><span class="label-tree-label__color" :style="colorStyle"></span><span v-text="label.name" @click.stop="toggleSelect"></span><span v-if="showFavourite" class="label-tree-label__favourite" @click.stop="toggleFavourite"><span class="glyphicon" :class="favouriteClass" aria-hidden="true" title=""></span></span><button v-if="deletable" type="button" class="close label-tree-label__delete" :title="deleteTitle" @click.stop="deleteThis"><span aria-hidden="true">&times;</span></button></div><ul v-if="label.open" class="label-tree__list"><label-tree-label :label="child" :deletable="deletable" v-for="child in label.children" @select="emitSelect" @deselect="emitDeselect" @delete="emitDelete"></label-tree-label></ul></li>',data:function(){return{favourite:!1}},props:{label:{type:Object,required:!0},showFavourite:{type:Boolean,required:!1},deletable:{type:Boolean,"default":!1}},computed:{classObject:function(){return{"label-tree-label--selected":this.label.selected,"label-tree-label--expandable":this.label.children}},colorStyle:function(){return{"background-color":"#"+this.label.color}},favouriteClass:function(){return{"glyphicon-star-empty":!this.favourite,"glyphicon-star":this.favourite}},deleteTitle:function(){return"Remove label "+this.label.name}},methods:{toggleSelect:function(){this.label.selected?this.$emit("deselect",this.label):this.$emit("select",this.label)},deleteThis:function(){this.emitDelete(this.label)},toggleOpen:function(){this.label.children?this.label.open=!this.label.open:this.toggleSelect()},toggleFavourite:function(){this.favourite=!this.favourite},emitSelect:function(e){this.$emit("select",e)},emitDeselect:function(e){this.$emit("deselect",e)},emitDelete:function(e){this.$emit("delete",e)}}}),biigle.$component("labelTrees.components.labelTypeahead",{template:'<typeahead class="label-typeahead clearfix" :data="labels" :placeholder="placeholder" :on-hit="selectLabel" :template="template" :disabled="disabled" :value="value" match-property="name"></typeahead>',data:function(){return{template:"{{item.name}}"}},components:{typeahead:VueStrap.typeahead},props:{labels:{type:Array,required:!0},placeholder:{type:String,"default":"Label name"},disabled:{type:Boolean,"default":!1},value:{type:String,"default":""}},methods:{selectLabel:function(e,t){this.$emit("select",e),t.reset()}}}),biigle.$component("labelTrees.components.manualLabelForm",{props:{labels:{type:Array,required:!0},color:{type:String,"default":""},parent:{type:Object,"default":null},name:{type:String,"default":""}},components:{labelTypeahead:biigle.$require("labelTrees.components.labelTypeahead")},computed:{selectedColor:{get:function(){return this.color},set:function(e){this.$emit("color",e)}},selectedName:{get:function(){return this.name},set:function(e){this.$emit("name",e)}},selectedParent:function(){return this.parent?this.parent.name:""},hasNoLabels:function(){return 0===this.labels.length},hasNoParent:function(){return!this.parent},hasNoName:function(){return!this.name}},methods:{refreshColor:function(){this.selectedColor=biigle.$require("labelTrees.randomColor")()},resetParent:function(){this.$emit("parent",null)},selectLabel:function(e){this.$emit("parent",e)},submit:function(){this.$emit("submit")}}}),angular.module("biigle.label-trees").controller("AuthorizedProjectsController",["$scope","LABEL_TREE","AUTH_PROJECTS","AUTH_OWN_PROJECTS","Project","LabelTreeAuthorizedProject",function(e,t,l,i,n,r){"use strict";var a=!1,o=!1,s=null,c=null,u=function(e){for(var t=l.length-1;t>=0;t--)if(l[t].id===e.id)return!1;return!0},d=function(e){c=e.filter(u)},b=function(e){msg.responseError(e),o=!1},f=function(e){l.push(e),i.push(e.id),d(s),o=!1},h=function(e){var t;for(t=l.length-1;t>=0;t--)if(l[t].id===e.id){l.splice(t,1);break}t=i.indexOf(e.id),-1!==t&&i.splice(t,1),d(s),o=!1};e.hasProjects=function(){return l.length>0},e.getProjects=function(){return l},e.isOwnProject=function(e){return-1!==i.indexOf(e.id)},e.isEditing=function(){return a},e.getVisibilityId=function(){return t.visibility_id},e.toggleEditing=function(){s||(s=n.query(d)),a=!a},e.isLoading=function(){return o},e.getProjectsForAuthorization=function(){return c},e.addAuthorizedProject=function(e){o=!0,r.addAuthorized({id:t.id},{id:e.id},function(){f(e)},b)},e.removeAuthorizedProject=function(e){o=!0,r.removeAuthorized({id:t.id},{id:e.id},function(){h(e)},b)}}]),angular.module("biigle.label-trees").controller("LabelTreeController",["$scope","LABEL_TREE","LabelTree","msg","$timeout","LabelTreeUser","USER_ID","REDIRECT_URL",function(e,t,l,i,n,r,a,o){"use strict";var s=!1,c=!1;e.labelTreeInfo={name:t.name,description:t.description,visibility_id:t.visibility_id.toString()};var u=function(e){i.responseError(e),c=!1},d=function(e){t.name=e.name,t.description=e.description,t.visibility_id=parseInt(e.visibility_id),s=!1,c=!1},b=function(){i.success("The label tree was deleted. Redirecting..."),n(function(){window.location.href=o},2e3)},f=function(e){e?(i.success("You left the label tree. Redirecting..."),n(function(){window.location.href=o},2e3)):(i.success("You left the label tree. Reloading..."),n(function(){window.location.reload()},2e3))};e.isEditing=function(){return s},e.toggleEditing=function(){s=!s},e.isSaving=function(){return c},e.getVisibilityId=function(){return t.visibility_id},e.getName=function(){return t.name},e.getDescription=function(){return t.description},e.saveChanges=function(){c=!0,l.update({id:t.id,name:e.labelTreeInfo.name,description:e.labelTreeInfo.description,visibility_id:parseInt(e.labelTreeInfo.visibility_id)},d,u)},e.discardChanges=function(){e.labelTreeInfo.name=t.name,e.labelTreeInfo.description=t.description,e.labelTreeInfo.visibility_id=t.visibility_id.toString(),s=!1},e.deleteTree=function(){confirm("Do you really want to delete the label tree "+t.name+"?")&&l["delete"]({id:t.id},b,i.responseError)},e.leaveTree=function(e){confirm("Do you really want to leave the label tree "+t.name+"?")&&r.detach({label_tree_id:t.id},{id:a},function(){f(e)},i.responseError)}}]),angular.module("biigle.label-trees").controller("LabelsController",["$scope","LABELS","LABEL_TREE","Label","msg","$q",function(e,t,l,i,n,r){"use strict";var a=!1,o=!1,s=null;e.tree={},e.openHierarchy=[];var c=function(e){n.responseError(e),o=!1},u=function(){e.tree={},t.forEach(function(t){var l=t.parent_id;e.tree[l]?e.tree[l].push(t):e.tree[l]=[t]})},d=function(l){Array.prototype.push.apply(t,l),u(),e.$broadcast("labels.refresh"),o=!1},b=function(l){for(var i=t.length-1;i>=0;i--)if(t[i].id===l.id){t.splice(i,1);break}u(),e.$broadcast("labels.refresh"),s&&s.id===l.id&&(s=f(l.parent_id)),e.selectLabel(s),o=!1},f=function(e){for(var l=t.length-1;l>=0;l--)if(t[l].id===e)return t[l];return null},h=function(t){var l=t;if(e.openHierarchy.length=0,l)for(;null!==l.parent_id;)e.openHierarchy.unshift(l.parent_id),l=f(l.parent_id)};e.selectLabel=function(t){s=t,h(t),e.$broadcast("labels.selected",t)},e.isSelectedLabel=function(e){return s&&s.id===e.id},e.hasLabels=function(){return t.length>0},e.isEditing=function(){return a},e.toggleEditing=function(){a=!a},e.getLabels=function(){return t},e.createLabel=function(e){if(o){var t=r.defer();return t.resolve([]),t.promise}return o=!0,e.label_tree_id=l.id,i.create(e,d,c).$promise},e.removeLabel=function(e,t){o=!0,t.stopPropagation(),i["delete"]({id:e.id},function(){b(e)},c)},e.isLoading=function(){return o},e.startLoading=function(){o=!0},e.stopLoading=function(){o=!1},u()}]),angular.module("biigle.label-trees").controller("ManualLabelsController",["$scope","randomColor",function(e,t){"use strict";var l={LABEL:null,NAME:""};e.selected={label:l.LABEL,color:t.get(),name:l.NAME};var i=function(){e.resetName(),e.selected.label&&"#"+e.selected.label.color===e.selected.color||e.refreshColor()};e.resetParent=function(){e.selectLabel(l.LABEL)},e.refreshColor=function(){e.selected.color=t.get()},e.resetName=function(){e.selected.name=l.NAME},e.isNameDirty=function(){return e.selected.name!==l.NAME},e.isParentDirty=function(){return e.selected.label!==l.LABEL},e.addLabel=function(){var t={name:e.selected.name,color:e.selected.color};e.selected.label&&(t.parent_id=e.selected.label.id),e.createLabel(t).then(i)},e.$on("labels.selected",function(t,l){e.selected.label=l,l&&(e.selected.color="#"+l.color)})}]),angular.module("biigle.label-trees").controller("MembersController",["$scope","LABEL_TREE","MEMBERS","ROLES","DEFAULT_ROLE_ID","USER_ID","LabelTreeUser","msg","User",function(e,t,l,i,n,r,a,o,s){"use strict";var c=!1,u=!1;e.newMember={user:null,role_id:n.toString()};var d=function(e){o.responseError(e),u=!1},b=function(e){e.role_id=parseInt(e.tmp_role_id),u=!1},f=function(e,t){e.tmp_role_id=e.role_id.toString(),d(t)},h=function(e){for(var t=l.length-1;t>=0;t--)if(l[t].id===e.id){l.splice(t,1);break}u=!1},p=function(e){for(var t=l.length-1;t>=0;t--)if(l[t].id===e.id)return!1;return!0},m=function(e){return e.filter(p)},g=function(t){t.tmp_role_id=t.role_id.toString(),l.push(t),e.newMember.user=null,u=!1};e.isEditing=function(){return c},e.toggleEditing=function(){c=!c},e.isLoading=function(){return u},e.getMembers=function(){return l},e.hasMembers=function(){return l.length>0},e.getRoles=function(){return i},e.getRole=function(e){return i[e]},e.isOwnUser=function(e){return r===e.id},e.updateRole=function(e){u=!0,a.update({label_tree_id:t.id},{id:e.id,role_id:parseInt(e.tmp_role_id)},function(){b(e)},function(t){f(e,t)})},e.detachMember=function(e){u=!0,a.detach({label_tree_id:t.id},{id:e.id},function(){h(e)},d)},e.username=function(e){return e&&e.firstname&&e.lastname?e.firstname+" "+e.lastname:""},e.findUser=function(e){return s.find({query:encodeURIComponent(e)}).$promise.then(m)},e.newMemberValid=function(){return e.newMember.user&&void 0!==e.newMember.user.id&&p(e.newMember.user)&&null!==e.newMember.role_id},e.attachMember=function(){if(e.newMemberValid()){u=!0;var l=e.newMember.user;l.role_id=parseInt(e.newMember.role_id),a.attach({label_tree_id:t.id},{id:l.id,role_id:l.role_id},function(){g(l)},d)}};for(var L=l.length-1;L>=0;L--)l[L].tmp_role_id=l[L].role_id.toString()}]),angular.module("biigle.label-trees").controller("WormsLabelsController",["$scope","LabelSource","LABEL_SOURCES","msg","randomColor",function(e,t,l,i,n){"use strict";var r=function(){for(var e=l.length-1;e>=0;e--)if("worms"===l[e].name)return l[e]}(),a={LABEL:null,NAME:""},o=[],s=!1,c=!1,u=[],d=function(t){s=!1,e.stopLoading(),i.responseError(t)},b=function(){s=!1,e.stopLoading()},f=function(t){for(var l=t.length-1;l>=0;l--)u.push(parseInt(t[l].source_id));e.selected.label&&"#"+e.selected.label.color===e.selected.color||e.refreshColor()};e.selected={label:a.LABEL,color:n.get(),name:a.NAME},e.getFindResults=function(){return o},e.isFinding=function(){return s},e.hasFindResults=function(){return o.length>0},e.find=function(){s=!0,e.startLoading(),o=t.query({id:r.id,query:e.selected.name},b,d)},e.getClassification=function(e){return e.parents.join(" > ")},e.resetParent=function(){e.selectLabel(a.LABEL)},e.refreshColor=function(){e.selected.color=n.get()},e.isNameDirty=function(){return e.selected.name!==a.NAME},e.isParentDirty=function(){return e.selected.label!==a.LABEL},e.toggleRecursive=function(){c=!c},e.isRecursive=function(){return c},e.addLabel=function(t){var l={name:t.name,color:e.selected.color,source_id:t.aphia_id,label_source_id:r.id};c?l.recursive="true":e.selected.label&&(l.parent_id=e.selected.label.id),e.createLabel(l).then(f)},e.getAddButtonTitle=function(t){return e.isRecursive()?"Add "+t.name+" and all WoRMS parents as new labels":e.isParentDirty()?"Add "+t.name+" as a child of "+e.selected.label.name:"Add "+t.name+" as a root label"},e.hasBeenImported=function(e){return-1!==u.indexOf(e.aphia_id)},e.$on("labels.selected",function(t,l){e.selected.label=l,l&&(e.selected.color="#"+l.color)})}]),angular.module("biigle.label-trees").directive("labelTreeItem",["$compile","$timeout","$templateCache",function(e,t,l){"use strict";return{restrict:"C",templateUrl:"label-item.html",scope:!0,link:function(i,n,r){var a=angular.element(l.get("label-subtree.html"));t(function(){n.append(e(a)(i))})},controller:["$scope",function(e){var t=!1,l=!1,i=!1,n=function(){-1!==e.openHierarchy.indexOf(e.item.id)?(t=!0,i=!1):e.isSelectedLabel(e.item)?(t=!0,i=!0):(t=!1,i=!1)},r=function(){l=e.tree&&e.tree.hasOwnProperty(e.item.id)};e.getSubtree=function(){return t?e.tree[e.item.id]:[]},e.getClass=function(){return{open:t,expandable:l,selected:i}},e.$on("labels.selected",n),e.$on("labels.refresh",r),n(),r()}]}}]),angular.module("biigle.label-trees").service("randomColor",function(){"use strict";var e=[0,.5,.9],t=[360,1,1],l=[0,2,2],i=function(e){var t,l=e[0]/60,i=Math.floor(l),n=l-i,r=[e[2]*(1-e[1]),e[2]*(1-e[1]*n),e[2]*(1-e[1]*(1-n))];switch(i){case 1:t=[r[1],e[2],r[0]];break;case 2:t=[r[0],e[2],r[2]];break;case 3:t=[r[0],r[1],e[2]];break;case 4:t=[r[2],r[0],e[2]];break;case 5:t=[e[2],r[0],r[1]];break;default:t=[e[2],r[2],r[0]]}return t.map(function(e){return Math.round(255*e)})},n=function(e){return e.map(function(e){return e=e.toString(16),1===e.length?"0"+e:e})};this.get=function(){for(var r,a=[0,0,0],o=a.length-1;o>=0;o--)r=10*l[o],a[o]=(t[o]-e[o])*Math.random()+e[o],0!==r?a[o]=Math.round(a[o]*r)/r:a[o]=Math.round(a[o]);return"#"+n(i(a)).join("")}});