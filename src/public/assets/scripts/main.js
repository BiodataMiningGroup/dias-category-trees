!function(e){var t={};function i(l){if(t[l])return t[l].exports;var n=t[l]={i:l,l:!1,exports:{}};return e[l].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,l){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:l})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(i.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(l,n,function(t){return e[t]}.bind(null,n));return l},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=0)}({0:function(e,t,i){i("WfG0"),e.exports=i("zcrr")},WfG0:function(e,t,i){"use strict";i.r(t);var l=biigle.$require("core.mixins.editor"),n=biigle.$require("events"),a=biigle.$require("messages").handleErrorResponse,s=biigle.$require("keyboard"),r=biigle.$require("api.labels"),o=biigle.$require("api.labelSource"),c=biigle.$require("api.labelTree"),d=biigle.$require("api.labelTreeVersion"),u=biigle.$require("core.mixins.loader"),h=biigle.$require("core.components.membersPanel"),f=biigle.$require("messages"),b=biigle.$require("api.projects"),p=biigle.$require("core.components.typeahead"),m={mixins:[p],props:{template:{default:'<span class="label-typeahead-item"><span v-if="item.color" :style="{\'background-color\': \'#\' + item.color}" class="label-color"></span><span v-text="item.name"></span></span>'}}};function v(e,t,i,l,n,a,s,r){var o,c="function"==typeof e?e.options:e;if(t&&(c.render=t,c.staticRenderFns=i,c._compiled=!0),l&&(c.functional=!0),a&&(c._scopeId="data-v-"+a),s?(o=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),n&&n.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(s)},c._ssrRegister=o):n&&(o=r?function(){n.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:n),o)if(c.functional){c._injectStyles=o;var d=c.render;c.render=function(e,t){return o.call(t),d(e,t)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,o):[o]}return{exports:e,options:c}}var g=v({name:"label-tree-label",data:function(){return{hover:!1,editing:!1,oldName:"",oldColor:"",newName:"",newColor:""}},props:{label:{type:Object,required:!0},showFavourites:{type:Boolean,required:!1},editable:{type:Boolean,default:!1},flat:{type:Boolean,default:!1}},computed:{showColor:function(){return!this.expandable||!this.hover},showChevronUp:function(){return!this.showColor&&this.label.open},showChevronDown:function(){return!this.showColor&&!this.label.open},classObject:function(){return{"label-tree-label--selected":this.label.selected,"label-tree-label--expandable":this.expandable,"label-tree-label--editing":this.editing}},colorStyle:function(){return{"background-color":"#"+this.label.color}},chevronStyle:function(){return{color:"#"+this.label.color}},favouriteClass:function(){return{selected:this.label.favourite}},favouriteTitle:function(){return(this.label.favourite?"Remove":"Add")+" as favourite"},editTitle:function(){return"Edit label "+this.label.name},deleteTitle:function(){return"Remove label "+this.label.name},expandable:function(){return!this.flat&&!!this.label.children}},methods:{toggleSelect:function(e){this.editing||(e.preventDefault(),this.label.selected?this.$emit("deselect",this.label,e):this.$emit("select",this.label,e))},editThis:function(){this.editing=!0,this.oldName=this.label.name,this.oldColor=this.label.color,this.newName=this.label.name,this.newColor="#"+this.label.color},saveThis:function(){var e=this;this.label.name=this.newName,this.label.color=this.newColor.substr(1),this.editing=!1,this.oldName===this.label.name&&this.oldColor===this.label.color||this.emitSave(this.label,(function(){return e.editing=!0}))},revertThis:function(){this.editing=!1,this.label.name=this.oldName,this.label.color=this.oldColor},deleteThis:function(){this.emitDelete(this.label)},toggleOpen:function(e){this.editing||(this.expandable?this.label.open=!this.label.open:this.toggleSelect(e))},toggleFavourite:function(){this.label.favourite?this.emitRemoveFavourite(this.label):this.emitAddFavourite(this.label)},emitSelect:function(e,t){this.$emit("select",e,t)},emitDeselect:function(e,t){this.$emit("deselect",e,t)},emitDelete:function(e){this.$emit("delete",e)},emitSave:function(e,t){this.$emit("save",e,t)},emitAddFavourite:function(e){this.$emit("add-favourite",e)},emitRemoveFavourite:function(e){this.$emit("remove-favourite",e)},doHover:function(){this.hover=!0},dontHover:function(){this.hover=!1}}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("li",{staticClass:"label-tree-label",class:e.classObject},[i("div",{staticClass:"label-tree-label__name",on:{click:e.toggleOpen,mouseover:e.doHover,mouseleave:e.dontHover}},[e.editing?i("span",[i("input",{directives:[{name:"model",rawName:"v-model",value:e.newColor,expression:"newColor"}],staticClass:"form-control input-sm label-tree-color-input",attrs:{type:"color"},domProps:{value:e.newColor},on:{input:function(t){t.target.composing||(e.newColor=t.target.value)}}}),e._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:e.newName,expression:"newName"}],staticClass:"form-control input-sm label-tree-label__name-input",attrs:{type:"text"},domProps:{value:e.newName},on:{keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.saveThis(t)},input:function(t){t.target.composing||(e.newName=t.target.value)}}})]):i("span",[i("span",{directives:[{name:"show",rawName:"v-show",value:e.showColor,expression:"showColor"}],staticClass:"label-tree-label__color",style:e.colorStyle}),e._v(" "),i("span",{directives:[{name:"show",rawName:"v-show",value:e.showChevronDown,expression:"showChevronDown"}],staticClass:"label-tree-label__chevron label-tree-label__chevron--down",style:e.chevronStyle}),e._v(" "),i("span",{directives:[{name:"show",rawName:"v-show",value:e.showChevronUp,expression:"showChevronUp"}],staticClass:"label-tree-label__chevron label-tree-label__chevron--up",style:e.chevronStyle}),e._v(" "),i("span",{domProps:{textContent:e._s(e.label.name)},on:{click:function(t){return t.stopPropagation(),e.toggleSelect(t)},mouseenter:e.dontHover}})]),e._v(" "),i("span",{staticClass:"label-tree-label__buttons"},[e.showFavourites?i("button",{staticClass:"label-tree-label__favourite",class:e.favouriteClass,attrs:{type:"button",title:e.favouriteTitle},on:{click:function(t){return t.stopPropagation(),e.toggleFavourite(t)}}},[i("span",{staticClass:"fa fa-star",attrs:{"aria-hidden":"true",title:""}})]):e._e(),e._v(" "),e.editable&&!e.editing?i("button",{attrs:{title:e.editTitle},on:{click:function(t){return t.stopPropagation(),e.editThis(t)}}},[i("span",{staticClass:"fa fa-pencil-alt",attrs:{"aria-hidden":"true"}})]):e._e(),e._v(" "),e.editing?i("button",{staticClass:"text-danger",attrs:{title:e.deleteTitle},on:{click:function(t){return t.stopPropagation(),e.deleteThis(t)}}},[i("span",{staticClass:"fa fa-trash",attrs:{"aria-hidden":"true"}})]):e._e(),e._v(" "),e.editing?i("button",{attrs:{title:"Revert changes"},on:{click:function(t){return t.stopPropagation(),e.revertThis(t)}}},[i("span",{staticClass:"fa fa-times",attrs:{"aria-hidden":"true"}})]):e._e(),e._v(" "),e.editing?i("button",{staticClass:"text-success",attrs:{title:"Save changes"},on:{click:function(t){return t.stopPropagation(),e.saveThis(t)}}},[i("span",{staticClass:"fa fa-check",attrs:{"aria-hidden":"true"}})]):e._e()])]),e._v(" "),e.expandable&&e.label.open?i("ul",{staticClass:"label-tree__list"},e._l(e.label.children,(function(t){return i("label-tree-label",{key:t.id,attrs:{label:t,editable:e.editable,"show-favourites":e.showFavourites},on:{select:e.emitSelect,deselect:e.emitDeselect,save:e.emitSave,delete:e.emitDelete,"add-favourite":e.emitAddFavourite,"remove-favourite":e.emitRemoveFavourite}})})),1):e._e()])}),[],!1,null,null,null),_=v({data:function(){return{collapsed:!1}},components:{labelTreeLabel:g.exports},props:{name:{type:String,required:!0},labels:{type:Array,required:!0},showTitle:{type:Boolean,default:!0},standalone:{type:Boolean,default:!1},collapsible:{type:Boolean,default:!0},multiselect:{type:Boolean,default:!1},allowSelectSiblings:{type:Boolean,default:!1},allowSelectChildren:{type:Boolean,default:!1},editable:{type:Boolean,default:!1},showFavourites:{type:Boolean,default:!1},flat:{type:Boolean,default:!1}},computed:{labelMap:function(){for(var e={},t=this.labels.length-1;t>=0;t--)e[this.labels[t].id]=this.labels[t];return e},compiledLabels:function(){var e={null:[]};return this.flat?this.labels.forEach((function(t){e.null.push(t)})):(this.labels.forEach((function(t){e.hasOwnProperty(t.parent_id)?e[t.parent_id].push(t):e[t.parent_id]=[t]})),this.labels.forEach((function(t){e.hasOwnProperty(t.id)?Vue.set(t,"children",e[t.id]):(Vue.set(t,"children",void 0),t.open=!1)}))),e},rootLabels:function(){return this.compiledLabels.null},collapseTitle:function(){return this.collapsed?"Expand":"Collapse"},hasNoLabels:function(){return 0===this.rootLabels.length}},methods:{hasLabel:function(e){return this.labelMap.hasOwnProperty(e)},getLabel:function(e){return this.labelMap[e]},getParents:function(e){for(var t=[];null!==e.parent_id;)e=this.getLabel(e.parent_id),t.unshift(e.id);return t},getSiblings:function(e){return null===e.parent_id?this.rootLabels:this.getLabel(e.parent_id).children},selectSiblings:function(e){this.getSiblings(e).forEach((function(e){e.selected=!0}))},deselectSiblings:function(e){this.getSiblings(e).forEach((function(e){e.selected=!1}))},selectChildren:function(e){var t=this;e.children&&e.children.forEach((function(e){e.selected=!0,t.selectChildren(e)}))},deselectChildren:function(e){var t=this;e.children&&e.children.forEach((function(e){e.selected=!1,t.deselectChildren(e)}))},emitSelect:function(e,t){this.$emit("select",e,t)},emitDeselect:function(e,t){this.$emit("deselect",e,t)},emitSave:function(e,t){this.$emit("save",e,t)},emitDelete:function(e){this.$emit("delete",e)},conditionSelectSiblings:function(e){return this.allowSelectSiblings&&e.altKey},conditionSelectChildren:function(e){return this.allowSelectChildren&&e.ctrlKey},selectLabel:function(e,t){var i=this;this.multiselect||this.clearSelectedLabels(),e&&this.hasLabel(e.id)&&(e.selected=!0,this.collapsed=!1,this.flat||(this.getParents(e).forEach((function(e){i.getLabel(e).open=!0})),this.multiselect&&(this.conditionSelectSiblings(t)&&this.selectSiblings(e),this.conditionSelectChildren(t)&&(this.selectChildren(e),this.conditionSelectSiblings(t)&&this.getSiblings(e).forEach(this.selectChildren)))))},deselectLabel:function(e,t){this.hasLabel(e.id)&&(e.selected=!1,this.conditionSelectSiblings(t)&&this.deselectSiblings(e),this.conditionSelectChildren(t)&&(this.deselectChildren(e),this.conditionSelectSiblings(t)&&this.getSiblings(e).forEach(this.deselectChildren)))},clearSelectedLabels:function(){this.labels.forEach((function(e){e.selected=!1}))},collapse:function(){if(this.collapsed)this.collapsed=!1;else{var e=!1;this.labels.forEach((function(t){e|=t.open,t.open=!1})),this.collapsed=!e}},emitAddFavourite:function(e){this.$emit("add-favourite",e)},emitRemoveFavourite:function(e){this.$emit("remove-favourite",e)},addFavouriteLabel:function(e){this.hasLabel(e.id)&&(e.favourite=!0)},removeFavouriteLabel:function(e){this.hasLabel(e.id)&&(e.favourite=!1)}},created:function(){this.labels.forEach((function(e){e.hasOwnProperty("open")||Vue.set(e,"open",!1),e.hasOwnProperty("selected")||Vue.set(e,"selected",!1),e.hasOwnProperty("favourite")||Vue.set(e,"favourite",!1)})),this.standalone?(this.$on("select",this.selectLabel),this.$on("deselect",this.deselectLabel)):(this.$parent.$on("select",this.selectLabel),this.$parent.$on("deselect",this.deselectLabel),this.$parent.$on("clear",this.clearSelectedLabels),this.$parent.$on("add-favourite",this.addFavouriteLabel),this.$parent.$on("remove-favourite",this.removeFavouriteLabel))}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"label-tree"},[e.showTitle?i("h4",{staticClass:"label-tree__title"},[e.collapsible?i("button",{staticClass:"btn btn-default btn-xs pull-right",attrs:{title:e.collapseTitle,type:"button"},on:{click:function(t){return t.stopPropagation(),e.collapse(t)}}},[e.collapsed?i("span",{staticClass:"fa fa-chevron-down",attrs:{"aria-hidden":"true"}}):i("span",{staticClass:"fa fa-chevron-up",attrs:{"aria-hidden":"true"}})]):e._e(),e._v("\n        "+e._s(e.name)+"\n    ")]):e._e(),e._v(" "),e.collapsed?e._e():i("ul",{staticClass:"label-tree__list"},[e._l(e.rootLabels,(function(t){return i("label-tree-label",{key:t.id,attrs:{label:t,editable:e.editable,"show-favourites":e.showFavourites,flat:e.flat},on:{select:e.emitSelect,deselect:e.emitDeselect,save:e.emitSave,delete:e.emitDelete,"add-favourite":e.emitAddFavourite,"remove-favourite":e.emitRemoveFavourite}})})),e._v(" "),e.hasNoLabels?i("li",{staticClass:"text-muted"},[e._v("No labels")]):e._e()],2)])}),[],!1,null,null,null).exports,y=v({components:{typeahead:m,labelTree:_},data:function(){return{favourites:[],typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.tree.versionedName"></small>'}},props:{trees:{type:Array,required:!0},id:{type:String},typeahead:{type:Boolean,default:!0},clearable:{type:Boolean,default:!0},multiselect:{type:Boolean,default:!1},allowSelectSiblings:{type:Boolean,default:!1},allowSelectChildren:{type:Boolean,default:!1},showFavourites:{type:Boolean,default:!1},collapsible:{type:Boolean,default:!0},listenerSet:{type:String,default:"default"}},computed:{localeCompareSupportsLocales:function(){try{"foo".localeCompare("bar","i")}catch(e){return"RangeError"===e.name}return!1},labels:function(){var e=[];if(this.trees.forEach((function(t){Array.prototype.push.apply(e,t.labels)})),this.localeCompareSupportsLocales){var t=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});e.sort((function(e,i){return t.compare(e.name,i.name)}))}else e.sort((function(e,t){return e.name<t.name?-1:1}));return e},favouriteIds:function(){return this.favourites.map((function(e){return e.id}))},canHaveMoreFavourites:function(){return this.favourites.length<10},hasFavourites:function(){return this.favourites.length>0},ownId:function(){if(this.id)return this.id;var e=[];for(var t in this.trees)this.trees.hasOwnProperty(t)&&e.push(this.trees[t].id);return e.join("-")},favouriteStorageKey:function(){return"biigle.label-trees.".concat(this.ownId,".favourites")}},methods:{handleSelect:function(e,t){e&&this.$emit("select",e,t)},handleDeselect:function(e,t){this.$emit("deselect",e,t)},clear:function(){this.$emit("clear")},handleAddFavourite:function(e){this.canHaveMoreFavourites&&(this.$emit("add-favourite",e),this.favourites.push(e),this.updateFavouriteStorage())},handleRemoveFavourite:function(e){this.$emit("remove-favourite",e);var t=this.favourites.indexOf(e);-1!==t&&this.favourites.splice(t,1),this.updateFavouriteStorage()},updateFavouriteStorage:function(){this.hasFavourites?localStorage.setItem(this.favouriteStorageKey,JSON.stringify(this.favouriteIds)):localStorage.removeItem(this.favouriteStorageKey)},selectFavourite:function(e){this.favourites[e]&&this.handleSelect(this.favourites[e])}},watch:{trees:{immediate:!0,handler:function(e){e.forEach((function(e){e.version?e.versionedName=e.name+" @ "+e.version.name:e.versionedName=e.name,e.labels.forEach((function(t){t.tree=e}))}))}}},mounted:function(){var e=this;if(this.showFavourites){var t=JSON.parse(localStorage.getItem(this.favouriteStorageKey));if(t){var i=[];this.labels.forEach((function(e){var l=t.indexOf(e.id);-1!==l&&(i[l]=e)})),i.filter(Boolean).forEach((function(t){e.handleAddFavourite(t)}))}for(var l=function(t,i){s.on(t,(function(){e.selectFavourite(i)}),0,e.listenerSet)},n=1;n<=9;n++)l(n.toString(),n-1);l("0",9)}}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"label-trees"},[e.typeahead||e.clearable?i("div",{staticClass:"label-trees__head"},[e.clearable?i("button",{staticClass:"btn btn-default",attrs:{title:"Clear selected labels",type:"button"},on:{click:e.clear}},[i("span",{staticClass:"fa fa-times fa-fw",attrs:{"aria-hidden":"true"}})]):e._e(),e._v(" "),e.typeahead?i("typeahead",{attrs:{items:e.labels,template:e.typeaheadTemplate,placeholder:"Find label"},on:{select:e.handleSelect}}):e._e()],1):e._e(),e._v(" "),i("div",{staticClass:"label-trees__body"},[e.hasFavourites?i("label-tree",{attrs:{name:"Favourites",labels:e.favourites,"show-favourites":e.showFavourites,flat:!0,collapsible:e.collapsible},on:{select:e.handleSelect,deselect:e.handleDeselect,"remove-favourite":e.handleRemoveFavourite}}):e._e(),e._v(" "),e._l(e.trees,(function(t){return i("label-tree",{key:t.id,attrs:{name:t.versionedName,labels:t.labels,multiselect:e.multiselect,"allow-select-siblings":e.allowSelectSiblings,"allow-select-children":e.allowSelectChildren,"show-favourites":e.showFavourites,collapsible:e.collapsible},on:{select:e.handleSelect,deselect:e.handleDeselect,"add-favourite":e.handleAddFavourite,"remove-favourite":e.handleRemoveFavourite}})}))],2)])}),[],!1,null,null,null).exports;biigle.$declare("labelTrees.components.labelTrees",y),biigle.$declare("labelTrees.components.labelTypeahead",m);var C={mixins:[u,l],data:{labelTree:null,ownProjects:[],authorizedProjects:[],authorizedOwnProjects:[],typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.description"></small>',privateId:null},components:{typeahead:p},computed:{isPrivate:function(){return this.labelTree.visibility_id===this.privateId},classObject:function(){return{"panel-warning":this.editing}},authorizableProjects:function(){var e=this;return this.ownProjects.filter((function(t){for(var i=e.authorizedProjects.length-1;i>=0;i--)if(e.authorizedProjects[i].id===t.id)return!1;return!0}))},hasAuthorizedProjects:function(){return this.authorizedProjects.length>0}},methods:{fetchOwnProjects:function(){var e=this;b.query().then((function(t){Vue.set(e,"ownProjects",t.body)}),a)},addAuthorizedProject:function(e){var t=this;e&&(this.startLoading(),c.addAuthorizedProject({id:this.labelTree.id},{id:e.id}).then((function(){return t.authorizedProjectAdded(e)}),a).finally(this.finishLoading))},authorizedProjectAdded:function(e){this.authorizedProjects.push(e),this.authorizedOwnProjects.push(e.id)},removeAuthorizedProject:function(e){var t=this;this.startLoading(),c.removeAuthorizedProject({id:this.labelTree.id,project_id:e.id}).then((function(){return t.authorizedProjectRemoved(e)}),a).finally(this.finishLoading)},authorizedProjectRemoved:function(e){var t;for(t=this.authorizedProjects.length-1;t>=0;t--)this.authorizedProjects[t].id===e.id&&this.authorizedProjects.splice(t,1);-1!==(t=this.authorizedOwnProjects.indexOf(e.id))&&this.authorizedOwnProjects.splice(t,1)},isOwnProject:function(e){return-1!==this.authorizedOwnProjects.indexOf(e.id)}},created:function(){this.privateId=biigle.$require("labelTrees.privateVisibilityId"),this.labelTree=biigle.$require("labelTrees.labelTree"),this.authorizedProjects=biigle.$require("labelTrees.authorizedProjects"),this.authorizedOwnProjects=biigle.$require("labelTrees.authorizedOwnProjects"),this.$once("editing.start",this.fetchOwnProjects)}},T=[0,.5,.9],L=[360,1,1],w=[0,2,2],S=function(){for(var e,t=[0,0,0],i=t.length-1;i>=0;i--)e=10*w[i],t[i]=(L[i]-T[i])*Math.random()+T[i],t[i]=0!==e?Math.round(t[i]*e)/e:Math.round(t[i]);return"#"+function(e){return e.map((function(e){return 1===(e=e.toString(16)).length?"0"+e:e}))}(function(e){var t,i=e[0]/60,l=Math.floor(i),n=i-l,a=[e[2]*(1-e[1]),e[2]*(1-e[1]*n),e[2]*(1-e[1]*(1-n))];switch(l){case 1:t=[a[1],e[2],a[0]];break;case 2:t=[a[0],e[2],a[2]];break;case 3:t=[a[0],a[1],e[2]];break;case 4:t=[a[2],a[0],e[2]];break;case 5:t=[e[2],a[0],a[1]];break;default:t=[e[2],a[2],a[0]]}return t.map((function(e){return Math.round(255*e)}))}(t)).join("")},$={props:{labels:{type:Array,required:!0},color:{type:String,default:""},parent:{type:Object,default:null},name:{type:String,default:""}},components:{typeahead:m},computed:{selectedColor:{get:function(){return this.color},set:function(e){this.$emit("color",e)}},selectedName:{get:function(){return this.name},set:function(e){this.$emit("name",e)}},selectedParent:function(){return this.parent?this.parent.name:""},hasNoLabels:function(){return 0===this.labels.length},hasNoParent:function(){return!this.parent},hasNoName:function(){return!this.name}},methods:{refreshColor:function(){this.selectedColor=S()},resetParent:function(){this.$emit("parent",null)},selectLabel:function(e){this.$emit("parent",e)}}},P={mixins:[$],methods:{submit:function(){var e={name:this.selectedName,color:this.selectedColor};this.parent&&(e.parent_id=this.parent.id),this.$emit("submit",e)}}},A={mixins:[$],components:{wormsResultItem:{props:{item:{type:Object,required:!0},recursive:{type:Boolean,required:!0},labels:{type:Array,required:!0},parent:{type:Object,default:null}},computed:{classification:function(){return this.item.parents.join(" > ")},buttonTitle:function(){return this.recursive?"Add ".concat(this.item.name," and all WoRMS parents as new labels"):this.parent?"Add ".concat(this.item.name," as a child of ").concat(this.parent.name):"Add ".concat(this.item.name," as a root label")},classObject:function(){return{"list-group-item-success":this.selected}},selected:function(){var e=this;return this.labels.some((function(t){return t.source_id==e.item.aphia_id}))}},methods:{select:function(){this.selected||this.$emit("select",this.item)}}}},data:function(){return{results:[],recursive:!1,hasSearched:!1,unaccepted:!1,worms:null}},computed:{hasResults:function(){return this.results.length>0},recursiveButtonClass:function(){return{active:this.recursive,"btn-info":this.recursive}},unacceptedButtonClass:function(){return{active:this.unaccepted,"btn-info":this.unaccepted}}},methods:{findName:function(){var e=this;this.$emit("load-start");var t={id:this.worms.id,query:this.selectedName};this.unaccepted&&(t.unaccepted="true"),o.query(t).then(this.updateResults,a).finally((function(){e.hasSearched=!0,e.$emit("load-finish")}))},updateResults:function(e){this.results=e.data},importItem:function(e){var t={name:e.name,color:this.selectedColor,source_id:e.aphia_id,label_source_id:this.worms.id};this.recursive?t.recursive="true":this.parent&&(t.parent_id=this.parent.id),this.$emit("submit",t)},toggleRecursive:function(){this.recursive=!this.recursive},toggleUnaccepted:function(){this.unaccepted=!this.unaccepted}},created:function(){this.worms=biigle.$require("labelTrees.wormsLabelSource")}},R={mixins:[u,l],data:{labelTree:null,labels:[],selectedColor:S(),selectedLabel:null,selectedName:""},components:{tabs:VueStrap.tabs,tab:VueStrap.tab,labelTree:_,manualLabelForm:P,wormsLabelForm:A},computed:{classObject:function(){return{"panel-warning":this.editing}}},methods:{saveLabel:function(e,t){this.startLoading(),r.update({id:e.id},{name:e.name,color:e.color}).catch((function(e){t(),a(e)})).finally(this.finishLoading)},deleteLabel:function(e){var t=this;this.startLoading(),r.delete({id:e.id}).then((function(){t.labelDeleted(e)}),a).finally(this.finishLoading)},labelDeleted:function(e){this.selectedLabel&&this.selectedLabel.id===e.id&&this.deselectLabel(e);for(var t=this.labels.length-1;t>=0;t--)if(this.labels[t].id===e.id){this.labels.splice(t,1);break}},selectLabel:function(e){this.selectedLabel=e,e?(this.selectedColor="#"+e.color,this.$emit("select",e),n.$emit("selectLabel",e)):(this.$emit("clear"),n.$emit("selectLabel",null))},deselectLabel:function(e){this.selectedLabel=null,this.$emit("deselect",e),n.$emit("selectLabel",null)},selectColor:function(e){this.selectedColor=e},selectName:function(e){this.selectedName=e},insertLabel:function(e){Vue.set(e,"open",!1),Vue.set(e,"selected",!1);for(var t=e.name.toLowerCase(),i=0,l=this.labels.length;i<l;i++)if(this.labels[i].name.toLowerCase()>=t)return void this.labels.splice(i,0,e);this.labels.push(e)},createLabel:function(e){this.loading||(this.startLoading(),r.save({label_tree_id:this.labelTree.id},e).then(this.labelCreated,a).finally(this.finishLoading))},labelCreated:function(e){e.data.forEach(this.insertLabel),this.selectedColor=S(),this.selectedName=""}},created:function(){this.labelTree=biigle.$require("labelTrees.labelTree"),this.labels=biigle.$require("labelTrees.labels")}},x={mixins:[u],data:{labelTree:null,members:[],roles:[],defaultRole:null,userId:null},components:{membersPanel:h},methods:{attachMember:function(e){var t=this;this.startLoading(),c.addUser({id:this.labelTree.id},{id:e.id,role_id:e.role_id}).then((function(){return t.memberAttached(e)}),a).finally(this.finishLoading)},memberAttached:function(e){this.members.push(e)},updateMember:function(e,t){var i=this;this.startLoading(),c.updateUser({id:this.labelTree.id,user_id:e.id},{role_id:t.role_id}).then((function(){return i.memberUpdated(e,t)}),a).finally(this.finishLoading)},memberUpdated:function(e,t){e.role_id=t.role_id},removeMember:function(e){var t=this;this.startLoading(),c.removeUser({id:this.labelTree.id,user_id:e.id}).then((function(){return t.memberRemoved(e)}),a).finally(this.finishLoading)},memberRemoved:function(e){for(var t=this.members.length-1;t>=0;t--)this.members[t].id===e.id&&this.members.splice(t,1)}},created:function(){this.labelTree=biigle.$require("labelTrees.labelTree"),this.members=biigle.$require("labelTrees.members"),this.roles=biigle.$require("labelTrees.roles"),this.defaultRole=biigle.$require("labelTrees.defaultRoleId"),this.userId=biigle.$require("labelTrees.userId")}},j=v({props:{item:{type:Object,required:!0},disabled:{type:Boolean,required:!1}},computed:{leftLabel:function(){return this.item.left},rightLabel:function(){return this.item.right},hasLeft:function(){return null!==this.leftLabel},hasRight:function(){return null!==this.rightLabel},labelToAdd:function(){return!this.hasLeft&&this.hasRight},labelToRemove:function(){return this.hasLeft&&!this.hasRight},labelsSame:function(){return this.hasLeft&&this.hasRight},leftColorStyle:function(){return{"background-color":"#"+this.leftLabel.color}},rightColorStyle:function(){return{"background-color":"#"+this.rightLabel.color}},classObject:function(){return{success:this.labelToAdd&&!this.accepted,"label-tree-diff-row--added":this.labelToAdd&&this.accepted,danger:this.labelToRemove&&!this.accepted,"label-tree-diff-row--removed":this.labelToRemove&&this.accepted}},labelStyle:function(){return{"padding-left":22*this.item.level+"px"}},addButtonClass:function(){return{"btn-success":this.accepted}},removeButtonClass:function(){return{"btn-danger":this.accepted}},accepted:function(){return this.item.accepted},acceptable:function(){return this.item.acceptable},labelAdded:function(){return this.labelToAdd&&this.accepted},removeTitle:function(){return this.acceptable?"Accept the deletion":"This label cannot be deleted because it or one of its child labels is used"}},methods:{emitResolved:function(){this.$emit("accepted",this.item)}}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("tr",{staticClass:"label-tree-diff-row",class:e.classObject},[i("td",{staticClass:"label-tree-diff-row__button"},[e.labelToAdd?i("button",{staticClass:"btn btn-sm btn-default",class:e.addButtonClass,attrs:{disabled:e.disabled,title:"Accept the addition"},on:{click:e.emitResolved}},[i("i",{staticClass:"fa fa-plus"})]):e._e(),e._v(" "),e.labelToRemove?i("button",{staticClass:"btn btn-sm btn-default",class:e.removeButtonClass,attrs:{title:e.removeTitle,disabled:!e.acceptable||e.disabled},on:{click:e.emitResolved}},[i("i",{staticClass:"fa fa-minus"})]):e._e()]),e._v(" "),i("td",{staticClass:"label-tree-diff-row__left"},[e.hasLeft?i("div",{staticClass:"label-tree-label",style:e.labelStyle},[i("div",{staticClass:"label-tree-label__name"},[i("span",{staticClass:"label-tree-label__color",style:e.leftColorStyle}),e._v(" "),i("span",{domProps:{textContent:e._s(e.leftLabel.name)}})])]):e._e(),e._v(" "),e.labelAdded?i("div",{staticClass:"label-tree-label",style:e.labelStyle},[i("div",{staticClass:"label-tree-label__name"},[i("span",{staticClass:"label-tree-label__color",style:e.rightColorStyle}),e._v(" "),i("span",{domProps:{textContent:e._s(e.rightLabel.name)}})])]):e._e()]),e._v(" "),i("td",{staticClass:"label-tree-diff-row__right"},[i("div",{staticClass:"label-tree-label",style:e.labelStyle},[e.hasRight?i("div",{staticClass:"label-tree-label__name"},[i("span",{staticClass:"label-tree-label__color",style:e.rightColorStyle}),e._v(" "),i("span",{domProps:{textContent:e._s(e.rightLabel.name)}})]):e._e()])])])}),[],!1,null,null,null),O=v({components:{labelTreeDiffRow:j.exports},data:function(){return{diff:[]}},props:{leftLabels:{type:Array,required:!0},leftName:{type:String,default:""},rightLabels:{type:Array,required:!0},rightName:{type:String,default:""},usedLabels:{type:Array,default:[]},disabled:{type:Boolean,default:!1}},computed:{leftLabelsById:function(){var e={};return this.leftLabels.forEach((function(t){e[t.id]=t})),e},leftLabelsAsTree:function(){var e=this.generateChildMap(this.leftLabels);return this.generateLabelsAsTree(e.null,e)},rightLabelsAsTree:function(){var e=this.generateChildMap(this.rightLabels);return this.generateLabelsAsTree(e.null,e)},usedLabelMap:function(){var e=this,t={};return this.usedLabels.forEach((function(i){do{t[i]=null,i=e.leftLabelsById[i].parent_id}while(null!==i)})),t},cannotResolveAll:function(){return this.disabled||this.diff.reduce((function(e,t){return t.acceptable?e&&t.accepted:e}),!0)},cannotResolveNone:function(){return this.disabled||this.diff.reduce((function(e,t){return t.acceptable?e&&!t.accepted:e}),!0)},hasDiff:function(){return this.diff.length>0}},methods:{generateChildMap:function(e){var t={};return e.forEach((function(e){t.hasOwnProperty(e.parent_id)?t[e.parent_id].push(e):t[e.parent_id]=[e]})),t},generateLabelsAsTree:function(e,t){var i=this;return e.map((function(e){return t.hasOwnProperty(e.id)?e.children=i.generateLabelsAsTree(t[e.id],t):e.children=[],e})).sort((function(e,t){return e.name+"-"+e.color<=t.name+"-"+t.color?-1:1}))},generateTreeDiff:function(e,t,i,l){var n=this;for(e=e.slice(),t=t.slice(),i=i||[],l=l||0;e.length>0&&t.length>0;){var a=e[0],s=t[0];a.name===s.name?(e.shift(),t.shift(),i.push({id:a.id,level:l,left:a,right:s}),this.generateTreeDiff(a.children,s.children,i,l+1)):a.name<s.name?(e.shift(),i.push({id:a.id,level:l,accepted:!1,acceptable:!this.usedLabelMap.hasOwnProperty(a.id),left:a,right:null}),this.generateTreeDiff(a.children,[],i,l+1)):(t.shift(),i.push({id:s.id,level:l,accepted:!1,acceptable:!0,left:null,right:s}),this.generateTreeDiff([],s.children,i,l+1))}return e.length>0&&e.forEach((function(e){i.push({id:e.id,level:l,accepted:!1,acceptable:!n.usedLabelMap.hasOwnProperty(e.id),left:e,right:null}),n.generateTreeDiff(e.children,[],i,l+1)})),t.length>0&&t.forEach((function(e){i.push({id:e.id,level:l,accepted:!1,acceptable:!0,left:null,right:e}),n.generateTreeDiff([],e.children,i,l+1)})),i},filterRelevantItems:function(e){var t=[];return e.forEach((function(e,i){null!==e.left&&null!==e.right||t.push(i)})),t.forEach((function(t){e[t].relevant=!0;for(var i=e[t].level,l=t;l>=0&&i>0;)e[l].level<i&&(e[l].relevant=!0,i=e[l].level),l-=1})),e.filter((function(e){return e.relevant}))},handleResolved:function(e){e.acceptable&&(e.accepted?(this.cancelResolved(e),null===e.left?this.acceptCancelAddAllChildren(e):null===e.right&&this.acceptCancelDeleteAllParents(e)):(this.setResolved(e),null===e.left?this.acceptAddAllParents(e):null===e.right&&this.acceptDeleteAllChildren(e)))},cancelResolved:function(e){null===e.left?this.$emit("cancel-add",e.right):null===e.right&&this.$emit("cancel-remove",e.left),e.accepted=!1},setResolved:function(e){null===e.left?this.$emit("add",e.right):null===e.right&&this.$emit("remove",e.left),e.accepted=!0},acceptAll:function(){var e=this;this.diff.forEach((function(t){t.accepted||e.handleResolved(t)}))},acceptNone:function(){var e=this;this.diff.forEach((function(t){t.accepted&&e.handleResolved(t)}))},doForAllChildren:function(e,t){for(var i=e.level+1,l=this.diff.indexOf(e)+1;this.diff[l]&&this.diff[l].level>=i;)t.call(this,this.diff[l]),l+=1},doForAllParents:function(e,t){for(var i=e.level,l=this.diff.indexOf(e)-1;i>0&&l>=0;)this.diff[l].level<i&&(i=this.diff[l].level,t.call(this,this.diff[l])),l-=1},acceptDeleteAllChildren:function(e){this.doForAllChildren(e,(function(e){null===e.right&&this.setResolved(e)}))},acceptCancelAddAllChildren:function(e){this.doForAllChildren(e,(function(e){null===e.left&&this.cancelResolved(e)}))},acceptAddAllParents:function(e){this.doForAllParents(e,(function(e){null===e.left&&this.setResolved(e)}))},acceptCancelDeleteAllParents:function(e){this.doForAllParents(e,(function(e){null===e.right&&this.cancelResolved(e)}))},setLeftParentIds:function(e){var t={};return e.forEach((function(e){e.right&&e.left&&(t[e.right.id]=e.left.id)})),e.forEach((function(e){e.right&&e.right.parent_id&&(e.right.left_parent_id=t[e.right.parent_id])})),e}},created:function(){var e=this.generateTreeDiff(this.leftLabelsAsTree,this.rightLabelsAsTree);e=this.filterRelevantItems(e),e=this.setLeftParentIds(e),this.diff=e}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"label-tree-diff"},[e.hasDiff?i("div",[i("button",{staticClass:"btn btn-default",attrs:{title:"Accept all merge items",disabled:e.cannotResolveAll},on:{click:e.acceptAll}},[e._v("\n                Accept all\n        ")]),e._v(" "),i("button",{staticClass:"btn btn-default",attrs:{title:"Set all merge items as not accepted",disabled:e.cannotResolveNone},on:{click:e.acceptNone}},[e._v("\n                Accept none\n        ")])]):e._e(),e._v(" "),e.hasDiff?i("table",{staticClass:"table table-hover"},[i("thead",[i("tr",[i("th"),e._v(" "),i("th",{domProps:{textContent:e._s(e.leftName)}}),e._v(" "),i("th",{domProps:{textContent:e._s(e.rightName)}})])]),e._v(" "),i("tbody",e._l(e.diff,(function(t){return i("label-tree-diff-row",{key:t.id,attrs:{item:t,disabled:e.disabled},on:{accepted:e.handleResolved}})})),1)]):i("div",{staticClass:"text-center lead"},[e._v("\n        The label trees are identical.\n    ")])])}),[],!1,null,null,null).exports,q=Vue.resource("api/v1/label-trees{/id}/merge-labels"),F={mixins:[u],components:{labelTreeDiff:O},data:{baseTree:null,mergeTree:null,usedLabels:[],toAdd:[],toRemove:[],merged:!1},computed:{baseTreeLabels:function(){return this.baseTree.labels},mergeTreeLabels:function(){return this.mergeTree.labels},cannotMerge:function(){return this.loading||0===this.toAdd.length&&0===this.toRemove.length},disableDiff:function(){return this.loading||this.merged}},methods:{handleAdd:function(e){-1===this.toAdd.indexOf(e)&&this.toAdd.push(e)},handleRemove:function(e){-1===this.toRemove.indexOf(e)&&this.toRemove.push(e)},handleCancelAdd:function(e){var t=this.toAdd.indexOf(e);-1!==t&&this.toAdd.splice(t,1)},handleCancelRemove:function(e){var t=this.toRemove.indexOf(e);-1!==t&&this.toRemove.splice(t,1)},bundleToAdd:function(e){var t={};e.forEach((function(e){t[e.id]={name:e.name,color:e.color,parent_id:e.parent_id,left_parent_id:e.left_parent_id}}));var i=[];return Object.keys(t).forEach((function(e){var l=t[e];l.parent_id&&t.hasOwnProperty(l.parent_id)?(t[l.parent_id].children?t[l.parent_id].children.push(l):t[l.parent_id].children=[l],delete l.parent_id,delete l.left_parent_id):(delete l.parent_id,l.left_parent_id&&(l.parent_id=l.left_parent_id),delete l.left_parent_id,i.push(l))})),i},bundleToRemove:function(e){return e.map((function(e){return e.id}))},submitMerge:function(){this.startLoading();var e=this.bundleToAdd(this.toAdd),t=this.bundleToRemove(this.toRemove);q.save({id:this.baseTree.id},{create:e,remove:t}).then(this.handleMergeSuccess,this.handleMergeError)},handleMergeError:function(e){this.finishLoading(),a(e)},handleMergeSuccess:function(){this.merged=!0}},created:function(){this.baseTree=biigle.$require("labelTrees.baseTree"),this.mergeTree=biigle.$require("labelTrees.mergeTree"),this.usedLabels=biigle.$require("labelTrees.usedLabels")}},E={components:{typeahead:p},data:{mergeUrlTemplate:null,mergeCandidates:[],typeaheadTemplate:'<span v-text="item.name"></span><br><small v-text="item.description"></small>',chosenCandidate:null},computed:{cannotContinue:function(){return null===this.chosenCandidate},continueUrl:function(){return this.chosenCandidate?this.mergeUrlTemplate.replace(":id",this.chosenCandidate.id):""}},methods:{parseLabelTreeVersionedName:function(e){return e.version&&(e.name=e.name+" @ "+e.version.name),e},chooseCandidate:function(e){this.chosenCandidate=e}},created:function(){this.mergeUrlTemplate=biigle.$require("labelTrees.mergeUrlTemplate"),this.mergeCandidates=biigle.$require("labelTrees.mergeCandidates").map(this.parseLabelTreeVersionedName)}},N={mixins:[u,l],data:{labelTree:null,name:null,description:null,visibility_id:null,userId:null,redirectUrl:null,privateVisibilityId:null},computed:{isPrivate:function(){return this.labelTree.visibility_id===this.privateVisibilityId},hasDescription:function(){return!!this.description},isChanged:function(){return this.name!==this.labelTree.name||this.description!==this.labelTree.description||parseInt(this.visibility_id)!==this.labelTree.visibility_id}},methods:{discardChanges:function(){this.finishEditing(),this.name=this.labelTree.name,this.description=this.labelTree.description,this.visibility_id=this.labelTree.visibility_id},leaveTree:function(){confirm("Do you really want to revoke your membership of label tree '".concat(this.labelTree.name,"'?"))&&(this.startLoading(),c.removeUser({id:this.labelTree.id,user_id:this.userId}).then(this.treeLeft,a).finally(this.finishLoading))},treeLeft:function(){var e=this;this.isPrivate?(f.success("You left the label tree. Redirecting..."),setTimeout((function(){return location.href=e.redirectUrl}),2e3)):location.reload()},deleteTree:function(){confirm("Do you really want to delete the label tree '".concat(this.labelTree.name,"'?"))&&(this.startLoading(),c.delete({id:this.labelTree.id}).then(this.treeDeleted,a).finally(this.finishLoading))},treeDeleted:function(){var e=this;f.success("The label tree was deleted. Redirecting..."),setTimeout((function(){return location.href=e.redirectUrl}),2e3)},saveChanges:function(){this.startLoading(),c.update({id:this.labelTree.id},{name:this.name,description:this.description,visibility_id:this.visibility_id}).then(this.changesSaved,a).finally(this.finishLoading)},changesSaved:function(){this.labelTree.name=this.name,this.labelTree.description=this.description,this.labelTree.visibility_id=parseInt(this.visibility_id),this.finishEditing()}},created:function(){this.privateVisibilityId=biigle.$require("labelTrees.privateVisibilityId"),this.labelTree=biigle.$require("labelTrees.labelTree"),this.userId=biigle.$require("labelTrees.userId"),this.redirectUrl=biigle.$require("labelTrees.redirectUrl"),this.name=this.labelTree.name,this.description=this.labelTree.description,this.visibility_id=this.labelTree.visibility_id}},D={mixins:[u],data:{version:null,redirectUrl:null},methods:{deleteVersion:function(){this.startLoading(),d.delete({id:this.version.id}).then(this.deleteSuccess,a)},deleteSuccess:function(){var e=this;f.success("The label tree version was deleted. Redirecting..."),setTimeout((function(){return location.href=e.redirectUrl}),2e3)}},created:function(){this.version=biigle.$require("labelTrees.version"),this.redirectUrl=biigle.$require("labelTrees.redirectUrl")}},k={mixins:[u],data:{doi:"",doiSaved:!1,version:null},computed:{doiUrl:function(){return"https://doi.org/"+this.doi},doiTitle:function(){return"DOI: "+this.doi}},methods:{cleanDoi:function(e){return e.replace(/^https?:\/\/doi\.org\//,"")},saveDoi:function(){this.doi=this.cleanDoi(this.doi),d.update({id:this.version.id},{doi:this.doi}).then(this.handleDoiSaved,a)},handleDoiSaved:function(){this.doiSaved=!0}},created:function(){this.version=biigle.$require("labelTrees.version")}};biigle.$mount("label-tree-version-title",D),biigle.$mount("label-tree-version-toolbar",k),biigle.$mount("label-trees-authorized-projects",C),biigle.$mount("label-trees-labels",R),biigle.$mount("label-trees-members",x),biigle.$mount("label-trees-title",N),biigle.$mount("merge-label-trees-container",F),biigle.$mount("merge-label-trees-index-container",E)},zcrr:function(e,t){}});